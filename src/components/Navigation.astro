---
import Menu from "./Menu.astro";
import MenuButton from "./MenuButton.astro";
import MenuItems from "./MenuItems.astro";
import LanguageSwitcher from "./LanguageSwitcher.astro";
import { useTranslations } from "../i18n/utils";
import { getLocalizedLinks } from "../content/links";
import type { Locale } from "../config/i18n";
import LogoIcon from "./LogoIcon.astro";
import Logo from "./Logo.astro";

interface Props {
  lang?: Locale;
}

const { lang = "ro" } = Astro.props;
const t = useTranslations(lang);

// Get localized navigation links from shared source
const navigationLinks = getLocalizedLinks(lang);
---

<style>
  #logo-container {
    transform: rotate(var(--logo-rotation));
  }
</style>
<header
  class="z-20 sticky top-0 my-4 py-2 px-4 h-16 flex justify-between gap-5 bg-light items-center container mx-auto"
>
  <div>
    <a href={`/${lang}`} class="flex gap-2">
      <div id="logo-container">
        <LogoIcon class="w-9 h-9 fill-primary" />
      </div>
      <Logo class="h-9 fill-primary" />
    </a>
  </div>
  <div class="flex items-center gap-1.5">
    <LanguageSwitcher currentLang={lang} />
    <Menu>
      <MenuItems class="z-10">
        <div
          class="css-animation bg-light fixed top-0 left-0 w-full h-full transition-transform -translate-y-full group-[.open]:translate-y-0 flex flex-col justify-center items-center"
        >
          <ul
            class="w-full h-full z-10 flex flex-col justify-center items-center backdrop-blur-md lg:gap-5 uppercase"
          >
            <li
              class="css-animation mb-6 opacity-0 -translate-x-20 group-[.open]:translate-x-0 group-[.open]:opacity-100 group-[.open]:delay-150 transition-all"
            >
              <a
                class="css-animation rounded-full px-10 py-2 uppercase transition-colors text-primary border-2 border-primary text-center"
                href={`/${lang}/ghidare`}
              >
                {t("nav.freeGuidance")}
              </a>
            </li>
            {
              navigationLinks.map(({ title, url, className }) => (
                <li class="m-6">
                  <a
                    class={`hover:text-secondary-blue text-primary transition-colors ${className ? className : ""}`}
                    href={url}
                  >
                    {title}
                  </a>
                </li>
              ))
            }
            <li
              class="css-animation mt-6 opacity-0 -translate-x-20 group-[.open]:translate-x-0 group-[.open]:opacity-100 group-[.open]:delay-150 transition-all"
            >
              <a
                class="css-animation bg-primary rounded-full px-10 py-2 text-light uppercase transition-colors"
                href={`/${lang}/new-facilitator`}
              >
                {t("nav.becomeFacilitator")}
              </a>
            </li>
          </ul>
        </div>
      </MenuItems>
      <MenuButton class="z-20" />
    </Menu>
  </div>
</header>

<div class="header-shadow z-10 fixed top-0 h-16 w-full bg-light"></div>
<!--
<a href="/">Home</a>
<a href="/about/">About</a>
<a href="/blog/">Blog</a> -->

<script>
  const debounce = <T extends (...args: any[]) => any>(fn: T) => {
    // This holds the requestAnimationFrame reference, so we can cancel it if we wish
    let frame: number;

    // The debounce function returns a new function that can receive a variable number of arguments
    return (...params: Parameters<T>) => {
      // If the frame variable has been defined, clear it now, and queue for next frame
      if (frame) {
        cancelAnimationFrame(frame);
      }

      // Queue our function call for the next frame
      frame = requestAnimationFrame(() => {
        // Call our function and pass any params we received
        fn(...params);
      });
    };
  };

  window.addEventListener("scroll", debounce(handleScroll));

  function handleScroll() {
    const htmlEl = document.documentElement;

    // Add shadow to header
    const headerShadowEl = document.querySelector(".header-shadow");
    if (!headerShadowEl) throw new Error("Header shadow element not found");

    if (htmlEl.scrollTop > 60) {
      headerShadowEl.classList.add("shadow-lg");
    } else {
      headerShadowEl.classList.remove("shadow-lg");
    }

    // Rotate logo based on scroll position
    const logoEl = document.getElementById("logo-container");
    if (!logoEl) throw new Error("Logo element not found");

    const percentage =
      htmlEl.scrollTop / (htmlEl.scrollHeight - htmlEl.clientHeight);

    logoEl.style.setProperty("--logo-rotation", `${percentage * 720}deg`);
  }
</script>
